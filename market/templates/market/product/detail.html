<!-- market/templates/market/product/detail.html -->
{% extends 'market/base.html' %}
{% load static %}
{% block title %}
    {{ product.name }}
{% endblock %}
{% block content %}
    <div class="product-detail">
        <img src="{% if product.image %}
                    {{ product.image.url }}
                  {% else %}
                    {% static 'img/no_image.png' %}
                  {% endif %}">
        <h1>{{ product.name }}</h1>
        <h2>
            <a href="{{ product.minicategory.get_absolute_url }}">
                {{ product.minicategory }}
            </a>
        </h2>
        <p class="price">{{ product.price }}원</p>
        <form id="add-to-cart-form" action="{% url 'cart:cart_add' product.id %}" method="post">
            <input type="hidden" name="quantity" value="1">
            <input type="hidden" name="override" value="False">
            {% csrf_token %}
            <input type="submit" value="Add to cart">
        </form>
        {{ product.description|linebreaks }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700&family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'bootstrap.min.css'%}">
<link rel="stylesheet" type="text/css" href="{% static 'style.css'%}">
 <style type="text/css">

     body{
        background-color: #c2a59d;
     }

    h1, h2, h3, h4, h5, h6 {
        font-family: "Nanum Myeongjo", serif; /* 제목 태그 */
        color: #333;
    }

    p {
        font-family: "Nanum Myeongjo", serif; /* 문단 */
        color: #555;
    }

      /* 이미지 호버 시 확대 효과 */
    .card-img-top {
        transition: transform 0.3s ease;
        border-radius: 8px; /* 둥근 모서리 설정 */
    }

    .card-img-top:hover {
        transform: scale(1.1); /* 10% 확대 */
    }
      .cart-form {
        display: flex;
        align-items: center;
    }
    .cart-form input {
        max-width: 3rem;
    }
    .cart-form button {
        margin-left: 1rem; /* 버튼 사이 간격 조정 */
    }

</style>
<body>
    <!-- Product section -->
    <section class="py-5">
        <div class="container px-4 px-lg-5 my-5">
            <div class="row gx-4 gx-lg-5 align-items-center">
                <div class="col-md-6">
                    <img class="card-img-top mb-5 mb-md-0" src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}" alt="Product Image">
                </div>
                <div class="col-md-6">
                    <h1 class="display-5 fw-bolder">{{ product.name }}</h1>
                    <div class="fs-5 mb-5">

                    <div class="d-flex">
                        <form id="add-to-cart-form" action="{% url 'cart:cart_add' product.id %}" method="post">
                            <input type="hidden" name="quantity" value="1">
                            <input type="hidden" name="override" value="False">
                            {% csrf_token %}
                            <input type="submit" value="Add to cart">
                        </form>

                        <a href="{{ product.get_review_url }}">{{ product.user.username }}</a>
                        <a href="{{ product.get_update_url }}" class="btn btn-outline-dark flex align-items-center" style="height: 3rem;">수정</a>
                        <button id="delete-button" class="btn btn-outline-dark flex align-items-center" style="height: 3rem;">삭제</button>
                        <a href="{% url 'chat:room' product.name product.id %}" class="btn btn-outline-dark flex align-items-center" style="height: 3rem;">채팅</a>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <!-- Map section -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div id="map" style="width:50%;height:400px;"></div>
            </div>
        </div>
    </div>
    <h5>{{ product.user.username }}</h5>
    {% if user.is_authenticated %}
        <a href="{% url 'chat:room' product.name product.user.id request.user.id %}">채팅</a>
    {% endif %}
    <div id="map" style="width:500px;height:400px;"></div>
    {% if user.is_authenticated and product.user.username == user.username %}
        <a href="{{ product.get_update_url }}">
            <input type="button" value="수정">
        </a>
        <button id="delete-button" class="btn btn-danger">삭제</button>
    {% endif %}

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e3165d2c3e60ad707e3de1280a966975&libraries=services"></script>
    <!-- Bootstrap core JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Kakao Maps API script -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e3165d2c3e60ad707e3de1280a966975&libraries=services"></script>
    <!-- Custom scripts -->
    <script>
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng({{ product.latitude }}, {{ product.longitude }}), // 제품의 좌표를 중심으로 설정
            level: 3
        };

        var map = new kakao.maps.Map(container, options);

        var marker = new kakao.maps.Marker({
            position: map.getCenter() // 마커를 지도 중심에 위치
        });

        marker.setMap(map); // 마커를 지도에 표시

        var infowindow = new kakao.maps.InfoWindow({
            content: '' // 초기에는 내용이 없는 인포윈도우 생성
        });

        // 마커에 마우스를 올렸을 때 이벤트 리스너 추가
        kakao.maps.event.addListener(marker, 'mouseover', function() {
            // 지오코더 객체 생성
            var geocoder = new kakao.maps.services.Geocoder();

            // 마커의 위치 가져오기
            var latlng = marker.getPosition();

            // 역 지오코딩 수행
            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    // 주소가 성공적으로 가져와졌을 경우, 주소를 표시
                    var address = result[0].address.address_name; // 주소를 필요에 맞게 포맷팅 가능

                    // 인포윈도우 내용 업데이트
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + address + '</div>');

                    // 마커 위에 인포윈도우 열기
                    infowindow.open(map, marker);
                } else {
                    // 지오코딩 실패 시 처리
                    console.error('주소를 가져오지 못했습니다.');
                }
            });
        });

        // 마커에서 마우스를 내렸을 때 이벤트 리스너 추가
        kakao.maps.event.addListener(marker, 'mouseout', function() {
            // 인포윈도우 닫기
            infowindow.close();
        });
    </script>
    <script>
        document.getElementById('delete-button').addEventListener('click', function() {
            if (confirm('이 제품을 삭제하시겠습니까?')) {
                fetch('{% url "market:product_delete" category_slug=product.category.slug minicategory_slug=product.minicategory.slug id=product.id %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{% url "market:product_list" category_slug=product.category.slug %}';
                    } else {
                        alert('제품 삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다. 다시 시도해 주세요.');
                });
            }
        });
    </script>

       <!-- Footer -->
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; team 27.5</p>
        </div>
    </footer>
{% endblock %}