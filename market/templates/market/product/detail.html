<!-- market/templates/market/product/detail.html -->
{% extends 'market/base.html' %}
{% load static %}
{% block title %}
    {{ product.name }}
{% endblock %}
{% block content %}
    <div class="product-detail">
        <img src="{% if product.image %}
                    {{ product.image.url }}
                  {% else %}
                    {% static 'img/no_image.png' %}
                  {% endif %}">
        <h1>{{ product.name }}</h1>
        <h2>
            <a href="{{ product.minicategory.get_absolute_url }}">
                {{ product.minicategory }}
            </a>
        </h2>
        <p class="price">{{ product.price }}원</p>
        <form action="{% url 'cart:cart_add' product.id %}" method="post">
            {{ cart_product_form }}
            {% csrf_token %}
            <input type="submit" value="Add to cart">
        </form>
        {{ product.description|linebreaks }}
    </div>
    <h5>{{ product.user.username }}</h5>
    <a href="{% url 'chat:room' product.name product.id %}">채팅</a>
    <div id="map" style="width:500px;height:400px;"></div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e3165d2c3e60ad707e3de1280a966975&libraries=services"></script>
    <script>
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng({{ product.latitude }}, {{ product.longitude }}), // 제품의 좌표를 중심으로 설정
            level: 3
        };

        var map = new kakao.maps.Map(container, options);

        var marker = new kakao.maps.Marker({
            position: map.getCenter() // 마커를 지도 중심에 위치
        });

        marker.setMap(map); // 마커를 지도에 표시

        var infowindow = new kakao.maps.InfoWindow({
            content: '' // 초기에는 내용이 없는 인포윈도우 생성
        });

        // 마커에 마우스를 올렸을 때 이벤트 리스너 추가
        kakao.maps.event.addListener(marker, 'mouseover', function() {
            // 지오코더 객체 생성
            var geocoder = new kakao.maps.services.Geocoder();

            // 마커의 위치 가져오기
            var latlng = marker.getPosition();

            // 역 지오코딩 수행
            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    // 주소가 성공적으로 가져와졌을 경우, 주소를 표시
                    var address = result[0].address.address_name; // 주소를 필요에 맞게 포맷팅 가능

                    // 인포윈도우 내용 업데이트
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + address + '</div>');

                    // 마커 위에 인포윈도우 열기
                    infowindow.open(map, marker);
                } else {
                    // 지오코딩 실패 시 처리
                    console.error('주소를 가져오지 못했습니다.');
                }
            });
        });

        // 마커에서 마우스를 내렸을 때 이벤트 리스너 추가
        kakao.maps.event.addListener(marker, 'mouseout', function() {
            // 인포윈도우 닫기
            infowindow.close();
        });
    </script>

    {% if user.is_authenticated and product.user.username == user.username %}
        <a href="{{ product.get_update_url }}">
            <input type="button" value="수정">
        </a>
        <button id="delete-button" class="btn btn-danger">삭제</button>
    {% endif %}
    <script>
        document.getElementById('delete-button').addEventListener('click', function() {
            if (confirm('이 제품을 삭제하시겠습니까?')) {
                fetch('{% url "market:product_delete" category_slug=product.category.slug minicategory_slug=product.minicategory.slug id=product.id %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{% url "market:product_list" category_slug=product.category.slug %}';
                    } else {
                        alert('제품 삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다. 다시 시도해 주세요.');
                });
            }
        });
    </script>
{% endblock %}